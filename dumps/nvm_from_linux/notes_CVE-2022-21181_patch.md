# Secure boot bypass patch analysis

After upgrading to Ubuntu 22.04, the exploit for CVE-2022-21181 described in <https://www.blackhat.com/us-22/briefings/schedule/#ghost-in-the-wireless-iwlwifi-edition-27062> no longer works.

- Dump loader code at 00060000 : no change

- NVM config: no change

    HW@a26c04 = 0x00000002
    HW@a33ffc = 0x0badadd7
    HW@a34000 = 0x0001f000
    HW@a34004 = 0x00018c00
    HW@a34008 = 0x0001d400
    HW@a3400c = 0x0001ec00

- Dump NVM at 0xa38000: a 0 became 4

```diff
 HWReg@a38000[0x1fc0]: 00a03308 00a04cc4 00a0330c ffffffff 00a03310 00a04cc8 00a03314 ffffffff
 HWReg@a38000[0x1fe0]: 00a03318 00a04ccc 00a0331c ffffffff 00a03320 00a04c00 00a03324 00000004
 HWReg@a38000[0x2000]: 00a03328 00a04ce0 00a0332c 007f47ff 00a03330 00000000 00a03334 00000000
-HWReg@a38000[0x2020]: 00a03338 00000000 00a0333c 00000000 00a03340 00ff0bad 02644001 00131007
+HWReg@a38000[0x2020]: 00a03338 00000000 00a0333c 00000004 00a03340 00ff0bad 02644001 00131007
 HWReg@a38000[0x2040]: 00000000 00314014 005d2526 000001ba 00000000 00000370 000000e0 00000000
 HWReg@a38000[0x2060]: 00000000 00000000 0000c02c 00348086 0000c000 25268086 0000c008 00000000
 HWReg@a38000[0x2080]: 0000c008 00000000 0000c008 02800031 0000809c 00105110 00008098 00000000
```

```sh
sudo cat /sys/kernel/debug/iwlwifi/*/iwlmvm/nvm_hw > wirelessAC_9560_nvm_dump/nvm_hw.bin
```

diff of parsing:

```diff
 1f64: type=10    count=148 (0xa0000094)                        | 1f64: type=10    count=148 (0xa0000094)
   => Match NVM dump file 'nvm_hw.bin'                          |   => Match NVM dump file 'nvm_hw.bin'
   => NVM section type HW                                       |   => NVM section type HW
   => hexdump -C /sys/kernel/debug/iwlwifi/*/iwlmvm/nvm_hw      |   => hexdump -C /sys/kernel/debug/iwlwifi/*/iwlmvm/nvm_hw
     [+ 10] WFMP_MAC_ADDR_0@0xa03080 = 0x4c1d96b8               |     [+ 10] WFMP_MAC_ADDR_0@0xa03080 = 0x4c1d96b8
     [+ 12] WFMP_MAC_ADDR_1@0xa03084 = 0x22ed                   |     [+ 12] WFMP_MAC_ADDR_1@0xa03084 = 0x22ed
     [+ 14] fwload_flags@0xa03088 = 0x0                         |     [+ 14] fwload_flags@0xa03088 = 0x0
     [+ 82] WFMP_MAC_ADDR_0@0xa03080 = 0x4c1d96b8               |     [+ 82] WFMP_MAC_ADDR_0@0xa03080 = 0x4c1d96b8
     [+ 84] WFMP_MAC_ADDR_1@0xa03084 = 0x22ed                   |     [+ 84] WFMP_MAC_ADDR_1@0xa03084 = 0x22ed
     [+ 86] fwload_flags@0xa03088 = 0x0                         |     [+ 86] fwload_flags@0xa03088 = 0x0
   [+000] 002c0020 00000000 000c00d0 00100100   .,............. |   [+000] 002c0020 00000000 000c00d0 00100100   .,.............
   [+004] 002c0140 5a5a5a50 000c01f0 000c0220  @.,.PZZZ.... ... |   [+004] 002c0140 5a5a5a50 000c01f0 000c0220  @.,.PZZZ.... ...
   [+008] 00a030d8 00000000 00a03080 4c1d96b8  .0.......0.....L |   [+008] 00a030d8 00000000 00a03080 4c1d96b8  .0.......0.....L
   [+00c] 00a03084 000022ed 00a03088 00000000  .0..."...0...... |   [+00c] 00a03084 000022ed 00a03088 00000000  .0..."...0......
   [+010] 00a0309c 02000000 00a03300 00a04cc0  .0.......3...L.. |   [+010] 00a0309c 02000000 00a03300 00a04cc0  .0.......3...L..
   [+014] 00a03304 ffffffff 00a03308 00a04cc4  .3.......3...L.. |   [+014] 00a03304 ffffffff 00a03308 00a04cc4  .3.......3...L..
   [+018] 00a0330c ffffffff 00a03310 00a04cc8  .3.......3...L.. |   [+018] 00a0330c ffffffff 00a03310 00a04cc8  .3.......3...L..
   [+01c] 00a03314 ffffffff 00a03318 00a04ccc  .3.......3...L.. |   [+01c] 00a03314 ffffffff 00a03318 00a04ccc  .3.......3...L..
   [+020] 00a0331c ffffffff 00a03320 00a04c00  .3...... 3...L.. |   [+020] 00a0331c ffffffff 00a03320 00a04c00  .3...... 3...L..
   [+024] 00a03324 00000004 00a03328 00a04ce0  $3......(3...L.. |   [+024] 00a03324 00000004 00a03328 00a04ce0  $3......(3...L..
   [+028] 00a0332c 007f47ff 00a03330 00000000  ,3...G..03...... |   [+028] 00a0332c 007f47ff 00a03330 00000000  ,3...G..03......
   [+02c] 00a03334 00000000 00a03338 00000000  43......83...... |   [+02c] 00a03334 00000000 00a03338 00000000  43......83......
-  [+030] 00a0333c 00000000 00a03340 00ff0bad  <3......@3...... |   [+030] 00a0333c 00000004 00a03340 00ff0bad  <3......@3...... 
   [+034] 02644001 00131007 00000000 00314014  .@d..........@1. |   [+034] 02644001 00131007 00000000 00314014  .@d..........@1.
   [+038] 005d2526 000001ba 00000000 00000370  &%].........p... |   [+038] 005d2526 000001ba 00000000 00000370  &%].........p...
   [+03c] 000000e0 00000000 00000000 00000000  ................ |   [+03c] 000000e0 00000000 00000000 00000000  ................
   [+040] 0000c02c 00348086 0000c000 25268086  ,.....4.......&% |   [+040] 0000c02c 00348086 0000c000 25268086  ,.....4.......&%
   [+044] 0000c008 00000000 0000c008 00000000  ................ |   [+044] 0000c008 00000000 0000c008 00000000  ................
   [+048] 0000c008 02800031 0000809c 00105110  ....1........Q.. |   [+048] 0000c008 02800031 0000809c 00105110  ....1........Q..
   [+04c] 00008098 00000000 00004000 2c4053fc  .........@...S@, |   [+04c] 00008098 00000000 00004000 2c4053fc  .........@...S@,
   [+050] 00a030d8 00000000 00a03080 4c1d96b8  .0.......0.....L |   [+050] 00a030d8 00000000 00a03080 4c1d96b8  .0.......0.....L
   [+054] 00a03084 000022ed 00a03088 00000000  .0..."...0...... |   [+054] 00a03084 000022ed 00a03088 00000000  .0..."...0......
   [+058] 00a0309c 02000000 00a03300 00a04cc0  .0.......3...L.. |   [+058] 00a0309c 02000000 00a03300 00a04cc0  .0.......3...L..
   [+05c] 00a03304 ffffffff 00a03308 00a04cc4  .3.......3...L.. |   [+05c] 00a03304 ffffffff 00a03308 00a04cc4  .3.......3...L..
   [+060] 00a0330c ffffffff 00a03310 00a04cc8  .3.......3...L.. |   [+060] 00a0330c ffffffff 00a03310 00a04cc8  .3.......3...L..
   [+064] 00a03314 ffffffff 00a03318 00a04ccc  .3.......3...L.. |   [+064] 00a03314 ffffffff 00a03318 00a04ccc  .3.......3...L..
   [+068] 00a0331c ffffffff 00a03320 00a04d00  .3...... 3...M.. |   [+068] 00a0331c ffffffff 00a03320 00a04d00  .3...... 3...M..
   [+06c] 00a03324 00040000 00a03328 00a04d04  $3......(3...M.. |   [+06c] 00a03324 00040000 00a03328 00a04d04  $3......(3...M..
   [+070] 00a0332c ff7f4fff 00a03330 00a04d04  ,3...O..03...M.. |   [+070] 00a0332c ff7f4fff 00a03330 00a04d04  ,3...O..03...M..
   [+074] 00a03334 00001fff 00a03338 00000000  43......83...... |   [+074] 00a03334 00001fff 00a03338 00000000  43......83......
   [+078] 00a0333c 00000000 00a03340 00ff0bad  <3......@3...... |   [+078] 00a0333c 00000000 00a03340 00ff0bad  <3......@3......
   [+07c] 02644001 00131007 00000000 00314015  .@d..........@1. |   [+07c] 02644001 00131007 00000000 00314015  .@d..........@1.
   [+080] 005d2720 000001ba 00000000 00000370   '].........p... |   [+080] 005d2720 000001ba 00000000 00000370   '].........p...
   [+084] 000000e0 00000000 00000000 00000000  ................ |   [+084] 000000e0 00000000 00000000 00000000  ................
   [+088] 0000c02c 00348086 0000c000 27208086  ,.....4....... ' |   [+088] 0000c02c 00348086 0000c000 27208086  ,.....4....... '
   [+08c] 0000c008 02800031 0000809c 00105110  ....1........Q.. |   [+08c] 0000c008 02800031 0000809c 00105110  ....1........Q..
   [+090] 00008098 00000000 00004000 284053fc  .........@...S@( |   [+090] 00008098 00000000 00004000 284053fc  .........@...S@(
```

With WFMP = Wireless Flow Management Protocol

So the value of register 0x00a0333c changed

```console
$ ./iwldebug.py reg 00x00a03300 17
00a03300: 0x00a04cc0
00a03304: 0xffffffff
00a03308: 0x00a04cc4
00a0330c: 0xffffffff
00a03310: 0x00a04cc8
00a03314: 0xffffffff
00a03318: 0x00a04ccc
00a0331c: 0xffffffff
00a03320: 0x00a04c00
00a03324: 0x00000004
00a03328: 0x00a04ce0
00a0332c: 0x007f47ff
00a03330: 0x00000000
00a03334: 0x00000000
00a03338: 0x00000000
00a0333c: 0x00000004
00a03340: 0x00ff0bad
```

```c
// iwl-prph.h
#define WFPM_PS_CTL_CLR			0xA0300C
#define WFMP_MAC_ADDR_0			0xA03080
#define WFMP_MAC_ADDR_1			0xA03084
#define LMPM_PMG_EN			0xA01CEC
#define RADIO_REG_SYS_MANUAL_DFT_0	0xAD4078
#define RFIC_REG_RD			0xAD0470
#define WFPM_CTRL_REG			0xA03030
#define WFPM_GP2			0xA030B4

#define WFPM_LMAC1_PS_CTL_RW 0xA03380
#define WFPM_LMAC2_PS_CTL_RW 0xA033C0
#define WFPM_PS_CTL_RW_PHYRF_PD_FSM_CURSTATE_MSK 0x0000000F
#define WFPM_PHYRF_STATE_ON 5
```

Access mask used in Loader code:

```text
    00a04c00: 0xffffffff        for 00400000..00420000
    00a04c04: 0xffffffff        for 00420000..00440000
    00a04c08: 0xffffffff        for 00440000..00460000
    00a04c0c: 0xffffffff        for 00460000..00480000
    00a04c10: 0x00000000        for 00480000..004a0000
    00a04c14: 0x00000000        for 004a0000..004c0000
    -
    00a04c20: 0xffffffff        for 00000000..00020000
    00a04c24: 0x00ffffff        for 00020000..00040000
    00a04c28: 0x00000000        for 00040000..00060000
    -
    00a04c40: 0x0000ffff        for 00080000..000a0000
    00a04c44: 0x00000000        for 000a0000..000c0000
    -
    00a04c60: 0x007fffff        for 00800000..00820000
    -
    00a04c80: 0x000000ff        for 00880000..008a0000
    -
    00a04ca0: 0x00000001        for ???
    -
    00a04cc0: 0xffffffff        for ???
    00a04cc4: 0xffffffff        for ???
    00a04cc8: 0xffffffff        for ???
    00a04ccc: 0xffffffff        for ???
    -
    00a04ce0: 0x007f57ff        for ???     (in NVM: 007f47ff)
    00a04ce4: 0x00000000        for ???
```

Try to decode `nvm_hw`:

```text
002c0020 00000000 000c00d0 00100100
002c0140 5a5a5a50 000c01f0 000c0220

00a030d8 00000000
00a03080 4c1d96b8  00a03084 000022ed  00a03088 00000000
    => WFMP_MAC_ADDR_0, WFMP_MAC_ADDR_1 for MAC address 4c:1d:96:b8:22:ed
00a0309c 02000000
00a03300 00a04cc0  00a03304 ffffffff  00a03308 00a04cc4  00a0330c ffffffff
00a03310 00a04cc8  00a03314 ffffffff  00a03318 00a04ccc  00a0331c ffffffff
00a03320 00a04c00  00a03324 00000004  00a03328 00a04ce0  00a0332c 007f47ff
00a03330 00000000  00a03334 00000000  00a03338 00000000  00a0333c 00000004 (this 4 was 0)
00a03340 00ff0bad

02644001 00131007
00000000 00314014
005d2526 000001ba
00000000 00000370
000000e0 00000000
00000000 00000000
0000c02c 00348086
0000c000 25268086
0000c008 00000000
0000c008 00000000
0000c008 02800031
0000809c 00105110
00008098 00000000
00004000 2c4053fc


00a030d8 00000000
00a03080 4c1d96b8  00a03084 000022ed  00a03088 00000000
00a0309c 02000000
00a03300 00a04cc0  00a03304 ffffffff  00a03308 00a04cc4  00a0330c ffffffff
00a03310 00a04cc8  00a03314 ffffffff  00a03318 00a04ccc  00a0331c ffffffff
00a03320 00a04d00  00a03324 00040000  00a03328 00a04d04  00a0332c ff7f4fff
00a03330 00a04d04  00a03334 00001fff  00a03338 00000000  00a0333c 00000000
00a03340 00ff0bad

02644001 00131007
00000000 00314015
005d2720 000001ba
00000000 00000370
000000e0 00000000
00000000 00000000
0000c02c 00348086
0000c000 27208086
0000c008 02800031
0000809c 00105110
00008098 00000000
00004000 284053fc
```

The access mask used with HW reg 00a04c00 to protect `00400000..00420000` is 4 = 1 << 2: protects `0x00402000..0x00403000`, where the stack is.
The Loader also uses data at 0x00401000 to load the content of the NVM! But this is not what changed.
